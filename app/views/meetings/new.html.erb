<% content_for :page_div do %>
  <div class="page" data-role="page" data-fullscreen="true" id="new_meeting_page">
<% end %>
<% content_for :heading do %>
  <%= link_to "Refresh", "#", "onclick" => "refreshCatchupPage()", 
          "data-icon" => "refresh", "data-role" => "button", "class" => "ui-btn-right" %>
  <h1>Catch up</h1>
<% end %>

<div id="new_catchup_list">
  <h3>Around me:</h3>
  <ul data-role="listview" id="around_me_list" data-inset="true" data-split-icon="delete" data-split-theme="a"> 
  </ul>
</div>
<div>
  <h3>Pending:</h3>
  <ul data-role="listview" id="pending_list" data-inset="true" data-split-icon="delete" data-split-theme="a"> 
  </ul>
</div>
<div>
  <h3>To confirm:</h3>
  <ul data-role="listview" id="to_confirm_list" data-inset="true" data-split-icon="delete" data-split-theme="a"> 
  </ul>
</div>
<div id="new_meeting_ctrlgrp">
  <div data-role="controlgroup" data-type="horizontal">
    <%= link_to "Use contact list", user_new_with_contact_path(current_user), "id" => "",  "data-role" => "button", "data-theme" => "b" %>
    <%= link_to "Use email", user_new_with_email_path(current_user), "id" => "",  "data-role" => "button", "data-theme" => "b" %>
  </div>
</div>

<script type="text/javascript">
  
  var getListDataId;
  
  $(document).on('pageshow', '#new_meeting_page', function (event) {
    // updates the current locatin of the user
    getPosition(sendGeoLocPosition);
    // updates the list every few seconds
    getListDataId = setInterval(function(){
      getListData();
    }, 2000);
  }).on('pagebeforehide', '#new_meeting_page', function (event) {
    // stops updating the page every few seconds
    clearInterval(getListDataId);
  });

  var getListData = function() {
      $.ajax("<%= user_update_catch_up_page_path(current_user) %>", {
          type: 'POST',
          success: updateList,
          error: function() { alert('error in getListData!') }
      });
  }

  var updateList = function(data) {
    // alert(data["arround_me"][1].name);
    var around_me_list = data["around_me"];
    $("#around_me_list").empty();
    for(i=0; i<around_me_list.length; i++) {
      var contact = around_me_list[i];
      $("#around_me_list").append("<li><a href=\"/users/"+data["user_id"]+"/meetings?user_to_meet="+contact.id+"\" data-confirm=\"You are catching up with "+contact.name+"?\" data-method=\"post\">"+contact.name+"</a></li>");
    }
    $('#around_me_list').listview('refresh');

    var to_confirm_list = data["to_confirm"];
    $('#to_confirm_list').empty();
    for(i=0; i<to_confirm_list.length; i++) {
      var contact = to_confirm_list[i];
      $("#to_confirm_list").append("<li><a href=\"/users/"+data["user_id"]+"/confirm_meeting?handshake_id="+contact["handshake_id"]+"\" data-confirm=\"You are you sure?\">"+contact["users"][0].name+"</a></li>");
    }
    $('#to_confirm_list').listview('refresh');
  }

  var sendGeoLocPosition = function(position) {
      // $.ajax("<%= user_update_catch_up_page_path(current_user) %>", {
      $.ajax("<%= user_update_position_path(current_user) %>", {  
          type: 'POST',
          data: { latitude: position.coords.latitude, 
                  longitude: position.coords.longitude },
          success: function(data) { 
            // alert(data) 
          },
          error: function() { alert('error in sending position!') }
      });
  }

  var refreshCatchupPage = function() {
    getListData();  
  }
</script>

<%= render :partial => 'layouts/footer', :locals => {:footer_tab => "catchup"} %>